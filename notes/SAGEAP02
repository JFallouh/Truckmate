WITH X AS
(
  SELECT 
    A.SOURCE_AUDIT CNTBTCH,
    ROW_NUMBER() OVER(PARTITION BY A.SOURCE_AUDIT ORDER BY A.SOURCE_AUDIT, V.USER3, A.BILL_NUMBER) CNTITEM,
    V.USER3 IDCUST,
    '1' TEXTTRX,
    A.BILL_NUMBER IDINVC,
    CAST(VARCHAR_FORMAT(A.TX_DATE, 'YYYY-MM-DD') AS VARCHAR(10)) DATEINVC,
    A.TX_REFERENCE ORDRNBR,
    '1' SWTAXBL,
    '0' SWCALCTX,
    '0' AMTTAX1,
    '0' AMTTAX2,
    CASE WHEN A.TX_TYPE = 'Credit' THEN A.TX_AMT * -1 ELSE A.TX_AMT END AMTGROSTOT,
    '1' SWMANTX,
    A.TX_TYPE,
    A.AP_BILL_ID
  FROM AP_BILL A
  JOIN VENDOR V ON V.VENDOR_ID = A.VENDOR_ID
  WHERE 1 = 1
    AND A.SOURCE_AUDIT > 0  
    AND A.SOURCE_REG = 'IP Register'
    AND A.SOURCE_AUDIT = :AUDIT
  ORDER BY 1, 3, 4
)

SELECT 
  X.CNTBTCH,
  X.CNTITEM,
  CASE WHEN E.GL_ACCT_ID LIKE '%-2200-%' THEN '40' ELSE '20' END CNTLINE,
    '0' AMTTAX1,
    '0' AMTTAX2,
  E.GL_ACCT_ID IDGLACCT,  
  CASE WHEN X.TX_TYPE = 'Credit' THEN E.TX_AMT * -1 ELSE E.TX_AMT END AMTDIST
FROM X
JOIN AP_BILL_EXP E ON E.AP_BILL_ID = X.AP_BILL_ID
ORDER BY CNTBTCH, CNTITEM, CNTLINE, IDGLACCT