SELECT
  S.SITE_NAME COMPANY,
  T.CALLNAME CALLER,  
  NVL(P3.BILL_NUMBER, P1.BILL_NUMBER, T.BILL_NUMBER) PARENT_BILL,  
  T.BILL_NUMBER,
  G.TRIP,
  G.LEG,
  G.LEG_MILES,
  G.EMPTY_LOADED,
  T.CURRENT_STATUS,
  O.ACTUAL_PICKUP PICKED_UP_ON,
  O.ACTUAL_DELIVERY DELIVERED_ON,
  O.BILL_DATE INVOICED_ON,
  (SELECT TRACE_NUMBER FROM TRACE WHERE TRACE_TYPE = 'P' AND DETAIL_NUMBER = T.DETAIL_LINE_ID LIMIT 1) PO,
  (SELECT TRACE_NUMBER FROM TRACE WHERE TRACE_TYPE = '1' AND DETAIL_NUMBER = T.DETAIL_LINE_ID LIMIT 1) BOL,
  (SELECT TRACE_NUMBER FROM TRACE WHERE TRACE_TYPE = '9' AND DETAIL_NUMBER = T.DETAIL_LINE_ID LIMIT 1) ORDER_NO,
  V.NAME CARRIER,
  D1.NAME DRIVER_1,
  D2.NAME DRIVER_2,
  G.TRUCK,
  G.TRAILER,
  T.ORIGNAME SHIPPER_NAME,
  T.ORIGADDR1 SHIPPER_ADDRESS1,
  T.ORIGADDR2 SHIPPER_ADDRESS2,
  T.ORIGCITY SHIPPER_CITY,
  T.ORIGPROV SHIPPER_STATE,
  (SELECT MIN(CHANGED) FROM ODRSTAT WHERE STATUS_CODE IN ('ARRSHIP', 'BR-ARRSHIP') AND ORDER_ID = O.DETAIL_LINE_ID) SHIPPER_ARRIVE,
  (SELECT MIN(CHANGED) FROM ODRSTAT WHERE STATUS_CODE IN ('DEPSHIP', 'BR-DEPSHIP') AND ORDER_ID = O.DETAIL_LINE_ID) SHIPPER_DEPART,
  T.DESTNAME CONSIGNEE_NAME,
  T.DESTADDR1 CONSIGNEE_ADDRESS1,
  T.DESTADDR2 CONSIGNEE_ADDRESS2,
  T.DESTCITY CONSIGNEE_CITY,
  T.DESTPROV CONSIGNEE_STATE,
  (SELECT MIN(CHANGED) FROM ODRSTAT WHERE STATUS_CODE IN ('ARRCONS', 'BR-ARRCONS') AND ORDER_ID = O.DETAIL_LINE_ID) CONSIGNEE_ARRIVE,
  (SELECT MIN(CHANGED) FROM ODRSTAT WHERE STATUS_CODE IN ('DEPCONS', 'BR-DEPCONS') AND ORDER_ID = O.DETAIL_LINE_ID) CONSIGNEE_DEPART,
  T.OP_CODE,
  CASE WHEN T.DANGEROUS_GOODS = 'True' THEN 'YES' ELSE 'NO' END HAZMAT,
  T.ROLLUP_PALLETS PALLETS,
  (SELECT SUM(LENGTH_1) FROM TLDTL WHERE PICK_ID = 0 AND ORDER_ID = T.DETAIL_LINE_ID) FEET,
  T.ROLLUP_WEIGHT WEIGHT,
  T.ROLLUP_CUBE CUBE,
  T.CURRENCY_CODE FB_CURRENCY,
  ROUND(G.REVENUE_SHIP, 2) REVENUE_SHIP,
  ROUND(G.REVENUE_FSC, 2) REVENUE_FSC,
  ROUND(G.REVENUE_ACC, 2) REVENUE_ACC,
  ROUND(G.REVENUE_TOTAL, 2) REVENUE_TOTAL,
  ROUND(G.IP_SHIP, 2) IP_SHIP,
  ROUND(G.IP_FSC, 2) IP_FSC,
  ROUND(G.IP_ACC, 2) IP_ACC,
  ROUND(G.IP_TOTAL, 2) IP_TOTAL,
  ROUND(G.DP, 2) DP,
  ROUND(G.TOTAL_COST, 2) TOTAL_COST,
  ROUND(G.MARGIN, 2) MARGIN,
  ROUND(CASE WHEN G.REVENUE_TOTAL <> 0 THEN G.MARGIN / G.REVENUE_TOTAL * 100 ELSE 0 END, 2) MARGIN_PERCENT,
  T.SALES_AGENT,
  O.CREATED_BY,
  CASE WHEN D1.NAME > '' THEN ROUND(G.REVENUE_TOTAL, 2) ELSE 0 END TLT_CHARGE
FROM RPT_GROSS_MARGIN_TLCI G
JOIN TRIP R ON R.TRIP_NUMBER = G.TRIP
LEFT JOIN TLORDER_ALL T ON T.DETAIL_LINE_ID = G.MAX_DLID
LEFT JOIN TLORDER_ALL O ON O.DETAIL_LINE_ID = G.MIN_DLID
LEFT JOIN VENDOR_ALL V ON V.VENDOR_ID = G.CARRIER_ID
LEFT JOIN DRIVER D1 ON D1.DRIVER_ID = G.DRIVER1_ID
LEFT JOIN DRIVER D2 ON D2.DRIVER_ID = G.DRIVER2_ID
LEFT JOIN SITE S ON S.SITE_ID = T.SITE_ID
LEFT JOIN TLORDER P1 ON P1.DETAIL_LINE_ID = T.MASTER_ORDER
LEFT JOIN TLORDER_SPLITS P2 ON P2.DETAIL_LINE_ID = O.DETAIL_LINE_ID
LEFT JOIN TLORDER P3 ON P3.DETAIL_LINE_ID = P2.ORIG_DETAIL_LINE_ID
--WHERE   NVL(P3.BILL_NUMBER, P1.BILL_NUMBER, T.BILL_NUMBER) IN ('C00000023', 'C00000038')

ORDER BY COMPANY, TRIP, LEG